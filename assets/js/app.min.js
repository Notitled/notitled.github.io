const CONFIG={DEBOUNCE_DELAY:300,SCROLL_THRESHOLD:300,WORDS_PER_MINUTE:200,CACHE_DURATION:36e5,ANIMATION_DELAY_INCREMENT:100,MAX_RETRIES:3,RETRY_DELAY_BASE:1e3};window.addEventListener("error",t=>{console.error("Global error:",t.error)}),window.addEventListener("unhandledrejection",t=>{console.error("Unhandled promise rejection:",t.reason)});class Blog{constructor(){this.posts=[],this.allPosts=[],this.currentView="home",this.app=document.getElementById("app"),this.loading=document.getElementById("loading"),this.navLinks=document.querySelectorAll(".nav-link"),this.loadedPosts=new Map,this.searchInput=document.getElementById("search-input"),this.scrollToTopBtn=document.getElementById("scroll-to-top"),this.themeToggle=document.querySelector(".theme-toggle"),this.init()}async init(){"undefined"!=typeof marked&&marked.setOptions({breaks:!0,gfm:!0,headerIds:!0,mangle:!1}),this.initTheme(),this.setupNavigation(),this.setupSearch(),this.setupScrollToTop(),this.setupThemeToggle(),await this.loadPosts(),this.render(),this.registerServiceWorker()}registerServiceWorker(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(t=>{console.log("ServiceWorker registered:",t.scope)}).catch(t=>{console.log("ServiceWorker registration failed:",t)})}initTheme(){const t=localStorage.getItem("theme");t?document.documentElement.setAttribute("data-theme",t):document.documentElement.setAttribute("data-theme","light")}setupThemeToggle(){this.themeToggle&&this.themeToggle.addEventListener("click",()=>{const t="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",t),localStorage.setItem("theme",t);const e=document.querySelector('meta[name="theme-color"]');e&&e.setAttribute("content","dark"===t?"#1a1a1a":"#ffffff")})}async loadPosts(){try{const t=await fetch("posts/index.json");if(!t.ok)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤");this.allPosts=await t.json(),this.posts=[...this.allPosts],this.posts.sort((t,e)=>new Date(e.date)-new Date(t.date))}catch(t){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:",t),this.posts=[],this.allPosts=[]}}async loadPost(t,e=CONFIG.MAX_RETRIES){if(this.loadedPosts.has(t))return this.loadedPosts.get(t);const s=this.getFromCache(t);if(s)return this.loadedPosts.set(t,s),s;for(let s=0;s<e;s++)try{const e=await fetch(`posts/${t}.md`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.text();if("undefined"==typeof marked)throw console.error("marked.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!"),new Error("Markdown –ø–∞—Ä—Å–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");const n=marked.parse(s);return this.loadedPosts.set(t,n),this.saveToCache(t,n),n}catch(n){if(s===e-1)return console.error("Failed to load post after retries:",n),console.error("Slug:",t),`\n                        <div class="error-state">\n                            <h2>üòî –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</h2>\n                            <p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ—Ç –ø–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>\n                            <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-top: 1rem;">\n                                –û—à–∏–±–∫–∞: ${n.message}\n                            </p>\n                            <a href="#" class="back-button">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ—Å—Ç–∞–º</a>\n                        </div>\n                    `;const r=CONFIG.RETRY_DELAY_BASE*(s+1);console.log(`Retry ${s+1}/${e} after ${r}ms...`),await new Promise(t=>setTimeout(t,r))}}getFromCache(t){try{const e=`blog_post_${t}`,s=localStorage.getItem(e);if(!s)return null;const{data:n,timestamp:r}=JSON.parse(s),a=Date.now()-r;return a<CONFIG.CACHE_DURATION?(console.log(`Cache hit for ${t} (age: ${Math.round(a/1e3)}s)`),n):(localStorage.removeItem(e),null)}catch(t){return console.error("Cache read error:",t),null}}saveToCache(t,e){try{const s=`blog_post_${t}`;localStorage.setItem(s,JSON.stringify({data:e,timestamp:Date.now()}))}catch(t){console.error("Cache write error:",t)}}setupSearch(){}performSearch(t){if(!t.trim())return this.allPosts;const e=t.toLowerCase();return this.allPosts.filter(t=>t.title.toLowerCase().includes(e)||t.excerpt.toLowerCase().includes(e)||t.tags&&t.tags.some(t=>t.toLowerCase().includes(e)))}setupSearchPage(){const t=document.getElementById("search-page-input"),e=document.getElementById("search-results");if(!t||!e)return;let s;const n=t=>{const s=this.performSearch(t);if(!t.trim())return void(e.innerHTML='<p class="search-hint">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º –ø–æ—Å—Ç–æ–≤</p>');if(0===s.length)return void(e.innerHTML='\n                    <div class="empty-state">\n                        <h2>üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h2>\n                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>\n                    </div>\n                ');const n=s.map((t,e)=>{const s=t.preview?`\n                    <div class="post-card-preview">\n                        <img src="${this.escapeHtml(t.preview)}"\n                             alt="${this.escapeHtml(t.title)}"\n                             loading="lazy">\n                    </div>\n                `:"";return`\n                    <article class="post-card" data-slug="${t.slug}" style="animation-delay: ${e*CONFIG.ANIMATION_DELAY_INCREMENT}ms">\n                        ${s}\n                        <div class="post-card-content">\n                            <div class="post-card-date">${this.formatDate(t.date)}</div>\n                            <h2 class="post-card-title">${this.escapeHtml(t.title)}</h2>\n                            <p class="post-card-excerpt">${this.escapeHtml(t.excerpt)}</p>\n                            <div class="post-card-meta">\n                                <span class="post-card-read-more">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</span>\n                            </div>\n                        </div>\n                    </article>\n                `}).join("");e.innerHTML=`\n                <p class="search-count">–ù–∞–π–¥–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: ${s.length}</p>\n                <div class="posts-grid">\n                    ${n}\n                </div>\n            `,e.querySelectorAll(".post-card").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.slug;this.navigateTo("post",e)})})};t.addEventListener("input",t=>{clearTimeout(s),s=setTimeout(()=>{n(t.target.value)},CONFIG.DEBOUNCE_DELAY)}),t.addEventListener("keydown",e=>{"Escape"===e.key&&(t.value="",n(""))})}setupScrollToTop(){this.scrollToTopBtn&&(window.addEventListener("scroll",()=>{window.scrollY>CONFIG.SCROLL_THRESHOLD?this.scrollToTopBtn.classList.add("visible"):this.scrollToTopBtn.classList.remove("visible"),"post"===this.currentView&&this.updateReadingProgress()}),this.scrollToTopBtn.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}))}updateReadingProgress(){const t=document.querySelector(".reading-progress");if(!t)return;const e=window.innerHeight,s=document.documentElement.scrollHeight-e,n=window.scrollY/s*100;t.style.width=`${Math.min(n,100)}%`}setupNavigation(){this.navLinks.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();const s=t.dataset.page;this.navigateTo(s)})}),window.addEventListener("popstate",t=>{t.state&&(this.currentView=t.state.view,this.currentSlug=t.state.slug,this.render(!1),this.updatePageMeta())})}navigateTo(t,e=null,s=!0){if(this.currentView=t,this.currentSlug=e,this.navLinks.forEach(e=>{e.classList.toggle("active",e.dataset.page===t)}),s){const s=e?`#${e}`:"home"===t?"#":`#${t}`;history.pushState({view:t,slug:e},"",s)}this.updatePageMeta(),this.render()}updatePageMeta(){let t="Notitled - –õ–∏—á–Ω—ã–π –±–ª–æ–≥",e="–õ–∏—á–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –±–ª–æ–≥ –æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ",s="https://notitled.github.io/";if("post"===this.currentView&&this.currentSlug){const n=this.posts.find(t=>t.slug===this.currentSlug);n&&(t=`${n.title} - Notitled`,e=n.excerpt,s=`https://notitled.github.io/#${this.currentSlug}`)}else"contacts"===this.currentView?(t="–ö–æ–Ω—Ç–∞–∫—Ç—ã - Notitled",e="–°–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π",s="https://notitled.github.io/#contacts"):"search"===this.currentView&&(t="–ü–æ–∏—Å–∫ - Notitled",e="–ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º –±–ª–æ–≥–∞",s="https://notitled.github.io/#search");document.title=t;const n=document.querySelector('meta[name="description"]');n&&n.setAttribute("content",e);let r=document.querySelector('link[rel="canonical"]');r||(r=document.createElement("link"),r.rel="canonical",document.head.appendChild(r)),r.href=s;const a=document.querySelector('meta[property="og:title"]'),o=document.querySelector('meta[property="og:description"]'),i=document.querySelector('meta[property="og:url"]');a&&a.setAttribute("content",t),o&&o.setAttribute("content",e),i&&i.setAttribute("content",s);const c=document.querySelector('meta[name="twitter:title"]'),l=document.querySelector('meta[name="twitter:description"]'),d=document.querySelector('meta[name="twitter:url"]');c&&c.setAttribute("content",t),l&&l.setAttribute("content",e),d&&d.setAttribute("content",s),this.updateStructuredData()}updateStructuredData(){const t=document.querySelector('script[type="application/ld+json"][data-dynamic]');t&&t.remove();let e=null;if("post"===this.currentView&&this.currentSlug){const t=this.posts.find(t=>t.slug===this.currentSlug);t&&(e={"@context":"https://schema.org","@type":"BlogPosting",headline:t.title,description:t.excerpt,datePublished:t.date,dateModified:t.date,author:{"@type":"Person",name:"Notitled",url:"https://notitled.github.io"},publisher:{"@type":"Person",name:"Notitled"},mainEntityOfPage:{"@type":"WebPage","@id":`https://notitled.github.io/#${this.currentSlug}`},url:`https://notitled.github.io/#${this.currentSlug}`,inLanguage:"ru-RU"},t.preview&&(e.image=`https://notitled.github.io/${t.preview}`))}if(e){const t=document.createElement("script");t.type="application/ld+json",t.setAttribute("data-dynamic","true"),t.textContent=JSON.stringify(e,null,2),document.head.appendChild(t)}}async render(t=!0){this.showLoading();let e="";switch(this.currentView){case"home":default:e=this.renderPostsList();break;case"post":e=await this.renderPost(this.currentSlug);break;case"search":e=this.renderSearch();break;case"contacts":e=this.renderContacts()}if("post"!==this.currentView){const t=document.querySelector(".reading-progress");t&&t.remove()}requestAnimationFrame(()=>{this.app.innerHTML=e,this.hideLoading(),"home"===this.currentView&&this.setupPostCardListeners();const t=this.app.querySelector(".back-button");t&&t.addEventListener("click",t=>{t.preventDefault(),this.navigateTo("home")}),"post"===this.currentView&&this.addReadingProgress(),"search"===this.currentView&&this.setupSearchPage(),window.scrollTo({top:0,behavior:"smooth"})})}addReadingProgress(){const t=document.querySelector(".reading-progress");t&&t.remove();const e=document.createElement("div");e.className="reading-progress",document.body.appendChild(e)}calculateReadTime(t){const e=t.replace(/<[^>]*>/g,"").trim().split(/\s+/).length;return Math.ceil(e/CONFIG.WORDS_PER_MINUTE)}renderPostsList(){if(0===this.posts.length){const t=this.searchInput&&this.searchInput.value.trim();return`\n                <div class="empty-state">\n                    <h2>${t?"üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ":"–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤"}</h2>\n                    <p>${t?"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å":"–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç –≤ –ø–∞–ø–∫—É <code>posts/</code>"}</p>\n                </div>\n            `}return`\n            <div class="posts-grid">\n                ${this.posts.map((t,e)=>{const s=t.preview?`\n                <div class="post-card-preview">\n                    <img src="${this.escapeHtml(t.preview)}" \n                         alt="${this.escapeHtml(t.title)}"\n                         loading="lazy">\n                </div>\n            `:"";return`\n                <article class="post-card" data-slug="${t.slug}" style="animation-delay: ${e*CONFIG.ANIMATION_DELAY_INCREMENT}ms">\n                    ${s}\n                    <div class="post-card-content">\n                        <div class="post-card-date">${this.formatDate(t.date)}</div>\n                        <h2 class="post-card-title">${this.escapeHtml(t.title)}</h2>\n                        <p class="post-card-excerpt">${this.escapeHtml(t.excerpt)}</p>\n                        <div class="post-card-meta">\n                            <span class="post-card-read-more">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</span>\n                        </div>\n                    </div>\n                </article>\n            `}).join("")}\n            </div>\n        `}async renderPost(t){const e=this.posts.find(e=>e.slug===t)||this.allPosts.find(e=>e.slug===t);if(!e)return'<div class="error">–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';const s=await this.loadPost(t),n=this.calculateReadTime(s);return`\n            <article class="post-view">\n                <a href="#" class="back-button">–ù–∞–∑–∞–¥ –∫ –ø–æ—Å—Ç–∞–º</a>\n                <header class="post-header">\n                    <div class="post-date">${this.formatDate(e.date)} ‚Ä¢ ${n} –º–∏–Ω —á—Ç–µ–Ω–∏—è</div>\n                    <h1 class="post-title">${this.escapeHtml(e.title)}</h1>\n                </header>\n                <div class="post-content">\n                    ${s}\n                </div>\n            </article>\n        `}renderSearch(){return'\n            <div class="search-page">\n                <h1>–ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º</h1>\n                \n                <div class="search-container-page">\n                    <input type="search" \n                           class="search-input" \n                           id="search-page-input" \n                           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞..." \n                           autocomplete="off" \n                           autofocus>\n                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">\n                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>\n                    </svg>\n                </div>\n                \n                <div id="search-results" class="search-results">\n                    <p class="search-hint">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º –ø–æ—Å—Ç–æ–≤</p>\n                </div>\n            </div>\n        '}renderContacts(){return'\n            <div class="contacts-page">\n                <h1>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h1>\n                \n                <div class="contact-item">\n                    <label>Email</label>\n                    <div class="contact-value">\n                        <a href="mailto:your.email@example.com">your.email@example.com</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>Telegram</label>\n                    <div class="contact-value">\n                        <a href="https://t.me/yourusername" target="_blank" rel="noopener">@yourusername</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>GitHub</label>\n                    <div class="contact-value">\n                        <a href="https://github.com/yourusername" target="_blank" rel="noopener">github.com/yourusername</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>Twitter / X</label>\n                    <div class="contact-value">\n                        <a href="https://twitter.com/yourusername" target="_blank" rel="noopener">@yourusername</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>LinkedIn</label>\n                    <div class="contact-value">\n                        <a href="https://linkedin.com/in/yourusername" target="_blank" rel="noopener">linkedin.com/in/yourusername</a>\n                    </div>\n                </div>\n            </div>\n        '}setupPostCardListeners(){this.app.querySelectorAll(".post-card").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.slug;this.navigateTo("post",e)})})}showLoading(){this.loading&&this.loading.classList.remove("hidden")}hideLoading(){this.loading&&this.loading.classList.add("hidden")}formatDate(t){return new Date(t).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new Blog}):new Blog;