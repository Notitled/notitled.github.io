const CONFIG={DEBOUNCE_DELAY:300,SCROLL_THRESHOLD:300,WORDS_PER_MINUTE:200,CACHE_DURATION:36e5,ANIMATION_DELAY_INCREMENT:100,MAX_RETRIES:3,RETRY_DELAY_BASE:1e3};window.addEventListener("error",e=>{console.error("Global error:",e.error)}),window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason)});class Blog{constructor(){this.posts=[],this.allPosts=[],this.currentView="home",this.app=document.getElementById("app"),this.loading=document.getElementById("loading"),this.navLinks=document.querySelectorAll(".nav-link"),this.loadedPosts=new Map,this.searchInput=document.getElementById("search-input"),this.scrollToTopBtn=document.getElementById("scroll-to-top"),this.themeToggle=document.querySelector(".theme-toggle"),this.init()}async init(){"undefined"!=typeof marked&&marked.setOptions({breaks:!0,gfm:!0,headerIds:!0,mangle:!1}),this.initTheme(),this.setupNavigation(),this.setupSearch(),this.setupScrollToTop(),this.setupThemeToggle(),await this.loadPosts(),this.render(),this.registerServiceWorker()}registerServiceWorker(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("ServiceWorker registered:",e.scope)}).catch(e=>{console.log("ServiceWorker registration failed:",e)})}initTheme(){const e=localStorage.getItem("theme");e?document.documentElement.setAttribute("data-theme",e):document.documentElement.setAttribute("data-theme","light")}setupThemeToggle(){this.themeToggle&&this.themeToggle.addEventListener("click",()=>{const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e);const t=document.querySelector('meta[name="theme-color"]');t&&t.setAttribute("content","dark"===e?"#1a1a1a":"#ffffff")})}async loadPosts(){try{const e=await fetch("posts/index.json");if(!e.ok)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤");this.allPosts=await e.json(),this.posts=[...this.allPosts],this.posts.sort((e,t)=>new Date(t.date)-new Date(e.date))}catch(e){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:",e),this.posts=[],this.allPosts=[]}}async loadPost(e,t=CONFIG.MAX_RETRIES){if(this.loadedPosts.has(e))return this.loadedPosts.get(e);const s=this.getFromCache(e);if(s)return this.loadedPosts.set(e,s),s;for(let s=0;s<t;s++)try{const t=await fetch(`posts/${e}.md`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=await t.text();if("undefined"==typeof marked)throw console.error("marked.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!"),new Error("Markdown –ø–∞—Ä—Å–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");const n=marked.parse(s);return this.loadedPosts.set(e,n),this.saveToCache(e,n),n}catch(n){if(s===t-1)return console.error("Failed to load post after retries:",n),console.error("Slug:",e),`\n                        <div class="error-state">\n                            <h2>üòî –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</h2>\n                            <p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ—Ç –ø–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>\n                            <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-top: 1rem;">\n                                –û—à–∏–±–∫–∞: ${n.message}\n                            </p>\n                            <a href="#" class="back-button">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ—Å—Ç–∞–º</a>\n                        </div>\n                    `;const a=CONFIG.RETRY_DELAY_BASE*(s+1);console.log(`Retry ${s+1}/${t} after ${a}ms...`),await new Promise(e=>setTimeout(e,a))}}getFromCache(e){try{const t=`blog_post_${e}`,s=localStorage.getItem(t);if(!s)return null;const{data:n,timestamp:a}=JSON.parse(s),r=Date.now()-a;return r<CONFIG.CACHE_DURATION?(console.log(`Cache hit for ${e} (age: ${Math.round(r/1e3)}s)`),n):(localStorage.removeItem(t),null)}catch(e){return console.error("Cache read error:",e),null}}saveToCache(e,t){try{const s=`blog_post_${e}`;localStorage.setItem(s,JSON.stringify({data:t,timestamp:Date.now()}))}catch(e){console.error("Cache write error:",e)}}setupSearch(){}performSearch(e){if(!e.trim())return this.allPosts;const t=e.toLowerCase();return this.allPosts.filter(e=>e.title.toLowerCase().includes(t)||e.excerpt.toLowerCase().includes(t)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(t)))}setupSearchPage(){const e=document.getElementById("search-page-input"),t=document.getElementById("search-results");if(!e||!t)return;let s;const n=e=>{const s=this.performSearch(e);if(!e.trim())return void(t.innerHTML='<p class="search-hint">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º –ø–æ—Å—Ç–æ–≤</p>');if(0===s.length)return void(t.innerHTML='\n                    <div class="empty-state">\n                        <h2>üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h2>\n                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>\n                    </div>\n                ');const n=s.map((e,t)=>{const s=e.preview?`\n                    <div class="post-card-preview">\n                        <img src="${this.escapeHtml(e.preview)}"\n                             alt="${this.escapeHtml(e.title)}"\n                             loading="lazy">\n                    </div>\n                `:"";return`\n                    <article class="post-card" data-slug="${e.slug}" style="animation-delay: ${t*CONFIG.ANIMATION_DELAY_INCREMENT}ms">\n                        ${s}\n                        <div class="post-card-content">\n                            <div class="post-card-date">${this.formatDate(e.date)}</div>\n                            <h2 class="post-card-title">${this.escapeHtml(e.title)}</h2>\n                            <p class="post-card-excerpt">${this.escapeHtml(e.excerpt)}</p>\n                            <div class="post-card-meta">\n                                <span class="post-card-read-more">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</span>\n                            </div>\n                        </div>\n                    </article>\n                `}).join("");t.innerHTML=`\n                <p class="search-count">–ù–∞–π–¥–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: ${s.length}</p>\n                <div class="posts-grid">\n                    ${n}\n                </div>\n            `,t.querySelectorAll(".post-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.slug;this.navigateTo("post",t)})})};e.addEventListener("input",e=>{clearTimeout(s),s=setTimeout(()=>{n(e.target.value)},CONFIG.DEBOUNCE_DELAY)}),e.addEventListener("keydown",t=>{"Escape"===t.key&&(e.value="",n(""))})}setupScrollToTop(){this.scrollToTopBtn&&(window.addEventListener("scroll",()=>{window.scrollY>CONFIG.SCROLL_THRESHOLD?this.scrollToTopBtn.classList.add("visible"):this.scrollToTopBtn.classList.remove("visible"),"post"===this.currentView&&this.updateReadingProgress()}),this.scrollToTopBtn.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}))}updateReadingProgress(){const e=document.querySelector(".reading-progress");if(!e)return;const t=window.innerHeight,s=document.documentElement.scrollHeight-t,n=window.scrollY/s*100;e.style.width=`${Math.min(n,100)}%`}setupNavigation(){this.navLinks.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.page;this.navigateTo(s)})}),window.addEventListener("popstate",e=>{e.state&&(this.currentView=e.state.view,this.currentSlug=e.state.slug,this.render(!1),this.updatePageMeta())})}navigateTo(e,t=null,s=!0){if(this.currentView=e,this.currentSlug=t,this.navLinks.forEach(t=>{t.classList.toggle("active",t.dataset.page===e)}),s){const s=t?`#${t}`:"home"===e?"#":`#${e}`;history.pushState({view:e,slug:t},"",s)}this.updatePageMeta(),this.render()}updatePageMeta(){let e="Notitled - –õ–∏—á–Ω—ã–π –±–ª–æ–≥",t="–õ–∏—á–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –±–ª–æ–≥ –æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ",s="https://sadcadf.github.io/";if("post"===this.currentView&&this.currentSlug){const n=this.posts.find(e=>e.slug===this.currentSlug);n&&(e=`${n.title} - Notitled`,t=n.excerpt,s=`https://sadcadf.github.io/#${this.currentSlug}`)}else"contacts"===this.currentView?(e="–ö–æ–Ω—Ç–∞–∫—Ç—ã - Notitled",t="–°–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π",s="https://sadcadf.github.io/#contacts"):"search"===this.currentView&&(e="–ü–æ–∏—Å–∫ - Notitled",t="–ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º –±–ª–æ–≥–∞",s="https://sadcadf.github.io/#search");document.title=e;const n=document.querySelector('meta[name="description"]');n&&n.setAttribute("content",t);let a=document.querySelector('link[rel="canonical"]');a||(a=document.createElement("link"),a.rel="canonical",document.head.appendChild(a)),a.href=s;const r=document.querySelector('meta[property="og:title"]'),o=document.querySelector('meta[property="og:description"]'),i=document.querySelector('meta[property="og:url"]');r&&r.setAttribute("content",e),o&&o.setAttribute("content",t),i&&i.setAttribute("content",s);const c=document.querySelector('meta[name="twitter:title"]'),l=document.querySelector('meta[name="twitter:description"]'),d=document.querySelector('meta[name="twitter:url"]');c&&c.setAttribute("content",e),l&&l.setAttribute("content",t),d&&d.setAttribute("content",s),this.updateStructuredData()}updateStructuredData(){const e=document.querySelector('script[type="application/ld+json"][data-dynamic]');e&&e.remove();let t=null;if("post"===this.currentView&&this.currentSlug){const e=this.posts.find(e=>e.slug===this.currentSlug);e&&(t={"@context":"https://schema.org","@type":"BlogPosting",headline:e.title,description:e.excerpt,datePublished:e.date,dateModified:e.date,author:{"@type":"Person",name:"Notitled",url:"https://sadcadf.github.io"},publisher:{"@type":"Person",name:"Notitled"},mainEntityOfPage:{"@type":"WebPage","@id":`https://sadcadf.github.io/#${this.currentSlug}`},url:`https://sadcadf.github.io/#${this.currentSlug}`,inLanguage:"ru-RU"},e.preview&&(t.image=`https://sadcadf.github.io/${e.preview}`))}if(t){const e=document.createElement("script");e.type="application/ld+json",e.setAttribute("data-dynamic","true"),e.textContent=JSON.stringify(t,null,2),document.head.appendChild(e)}}async render(e=!0){this.showLoading();let t="";switch(this.currentView){case"home":default:t=this.renderPostsList();break;case"post":t=await this.renderPost(this.currentSlug);break;case"search":t=this.renderSearch();break;case"contacts":t=this.renderContacts()}if("post"!==this.currentView){const e=document.querySelector(".reading-progress");e&&e.remove()}requestAnimationFrame(()=>{this.app.innerHTML=t,this.hideLoading(),"home"===this.currentView&&this.setupPostCardListeners();const e=this.app.querySelector(".back-button");e&&e.addEventListener("click",e=>{e.preventDefault(),this.navigateTo("home")}),"post"===this.currentView&&this.addReadingProgress(),"search"===this.currentView&&this.setupSearchPage(),window.scrollTo({top:0,behavior:"smooth"})})}addReadingProgress(){const e=document.querySelector(".reading-progress");e&&e.remove();const t=document.createElement("div");t.className="reading-progress",document.body.appendChild(t)}calculateReadTime(e){const t=e.replace(/<[^>]*>/g,"").trim().split(/\s+/).length;return Math.ceil(t/CONFIG.WORDS_PER_MINUTE)}renderPostsList(){if(0===this.posts.length){const e=this.searchInput&&this.searchInput.value.trim();return`\n                <div class="empty-state">\n                    <h2>${e?"üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ":"–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤"}</h2>\n                    <p>${e?"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å":"–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç –≤ –ø–∞–ø–∫—É <code>posts/</code>"}</p>\n                </div>\n            `}return`\n            <div class="posts-grid">\n                ${this.posts.map((e,t)=>{const s=e.preview?`\n                <div class="post-card-preview">\n                    <img src="${this.escapeHtml(e.preview)}" \n                         alt="${this.escapeHtml(e.title)}"\n                         loading="lazy">\n                </div>\n            `:"";return`\n                <article class="post-card" data-slug="${e.slug}" style="animation-delay: ${t*CONFIG.ANIMATION_DELAY_INCREMENT}ms">\n                    ${s}\n                    <div class="post-card-content">\n                        <div class="post-card-date">${this.formatDate(e.date)}</div>\n                        <h2 class="post-card-title">${this.escapeHtml(e.title)}</h2>\n                        <p class="post-card-excerpt">${this.escapeHtml(e.excerpt)}</p>\n                        <div class="post-card-meta">\n                            <span class="post-card-read-more">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</span>\n                        </div>\n                    </div>\n                </article>\n            `}).join("")}\n            </div>\n        `}async renderPost(e){const t=this.posts.find(t=>t.slug===e)||this.allPosts.find(t=>t.slug===e);if(!t)return'<div class="error">–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';const s=await this.loadPost(e),n=this.calculateReadTime(s);return`\n            <article class="post-view">\n                <a href="#" class="back-button">–ù–∞–∑–∞–¥ –∫ –ø–æ—Å—Ç–∞–º</a>\n                <header class="post-header">\n                    <div class="post-date">${this.formatDate(t.date)} ‚Ä¢ ${n} –º–∏–Ω —á—Ç–µ–Ω–∏—è</div>\n                    <h1 class="post-title">${this.escapeHtml(t.title)}</h1>\n                </header>\n                <div class="post-content">\n                    ${s}\n                </div>\n            </article>\n        `}renderSearch(){return'\n            <div class="search-page">\n                <h1>–ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º</h1>\n                \n                <div class="search-container-page">\n                    <input type="search" \n                           class="search-input" \n                           id="search-page-input" \n                           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞..." \n                           autocomplete="off" \n                           autofocus>\n                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">\n                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>\n                    </svg>\n                </div>\n                \n                <div id="search-results" class="search-results">\n                    <p class="search-hint">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º –ø–æ—Å—Ç–æ–≤</p>\n                </div>\n            </div>\n        '}renderContacts(){return'\n            <div class="contacts-page">\n                <h1>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h1>\n                \n                <div class="contact-item">\n                    <label>Email</label>\n                    <div class="contact-value">\n                        <a href="mailto:your.email@example.com">your.email@example.com</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>Telegram</label>\n                    <div class="contact-value">\n                        <a href="https://t.me/yourusername" target="_blank" rel="noopener">@yourusername</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>GitHub</label>\n                    <div class="contact-value">\n                        <a href="https://github.com/yourusername" target="_blank" rel="noopener">github.com/yourusername</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>Twitter / X</label>\n                    <div class="contact-value">\n                        <a href="https://twitter.com/yourusername" target="_blank" rel="noopener">@yourusername</a>\n                    </div>\n                </div>\n                \n                <div class="contact-item">\n                    <label>LinkedIn</label>\n                    <div class="contact-value">\n                        <a href="https://linkedin.com/in/yourusername" target="_blank" rel="noopener">linkedin.com/in/yourusername</a>\n                    </div>\n                </div>\n            </div>\n        '}setupPostCardListeners(){this.app.querySelectorAll(".post-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.slug;this.navigateTo("post",t)})})}showLoading(){this.loading&&this.loading.classList.remove("hidden")}hideLoading(){this.loading&&this.loading.classList.add("hidden")}formatDate(e){return new Date(e).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new Blog}):new Blog;